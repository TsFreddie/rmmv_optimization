# RPG ツクール MV 用最適化プラグイン

**他の言語:** [English](README.md)

これは雲天堂のゲーム（「ポリドッグパトロール」および「便機戦争」）のパフォーマンスを最適化するためのプラグイン集（オリジナルおよび派生）です。このリポジトリは雲天堂とは一切関係ありません。

## ライセンスに関する注意

以下のファイルは Triacontane の派生作品です：

- DTextPicture.js
- KMS_Minimap.js

それぞれのライセンスはファイルヘッダーに記載されています。派生作品には各ファイルの末尾に `// HACK:` ヘッダーが付けられています。派生作品は本リポジトリのライセンスのもと、元のライセンスと同様に取り扱われます。

以下のファイルはプロトコル互換の書き換えであり、本リポジトリのライセンスに基づいて提供されます：

- PictureZIndex.js

以下のファイルはオリジナル作品であり、本リポジトリのライセンスに基づいて提供されます：

- BruteForceOptimization.js
- BruteForceOptimizationPolidog.js
- BruteForceOptimizationBenki.js

## インストール方法

インストールする前に、ポリドッグパトロール または 便機戦争 の正規コピーを所持していることを確認してください。購入は [雲天堂](https://www.untendo.com/) から可能です。

1. （推奨）最新の [NW.js](https://nwjs.io/) をダウンロードし、元のファイルを置き換えた上で `nw.exe` を使ってゲームを起動してください。
2. このリポジトリをダウンロードし、すべてのファイルを `www/js/plugins` ディレクトリへコピーしてください。上書きするよう促された場合はそのまま上書きしてください。
3. `www/js/plugins.js` を開き、以下の行を最後の行の前に追加してください：

ポリドッグパトロール 用:

```
{"name":"BruteForceOptimization","status":true,"description":"","parameters":{}},
{"name":"BruteForceOptimizationPolidog","status":true,"description":"","parameters":{}},
```

便機戦争 用:

```
{"name":"BruteForceOptimization","status":true,"description":"","parameters":{}},
{"name":"BruteForceOptimizationBenki","status":true,"description":"","parameters":{}},
```

注：ゲームに自動フレームレートモードがある場合は、必ずフレームレートを 60fps に設定してください。最適化が施されていても、ゲームが混乱してフレーム落ちが発生する可能性があります。

## その他の RPG ツクール MV ゲーム

`BruteForceOptimization.js` プラグインは汎用的な RPG ツクール MV プラグインとして設定されていますが、他のゲームでのテストは行っていません。ご自身のゲームで使用することに興味がある場合は、プラグインが何を行うかを理解するため、以下の最適化の記述をお読みになることをお勧めします。ゲームに合わせてプラグインを修正する必要があるか、全く動作しない可能性があります。

## 最適化の記述

このリポジトリで使用されている最適化技術の概要は以下の通りです：

- RPG ツクール MV のインタープリタの再構築：
  - ホットパスを手動でインライン化
  - 実行時の解釈と JIT によるオーバーヘッドを排除するため、`eval`でラップされた関数呼び出しを事前実行
  - ジャンプ分岐のターゲットを事前計算
  - 多くの配列アクセス関数呼び出しを直接アクセスに置換し、境界チェックをバイパス
- 音声ファイルのキャッシュにより、重複する復号処理を削減
- 復号処理を Web ワーカーに移行し、メインスレッドの停止を緩和
- 色調変更済み画像のキャッシュにより、重複する色調処理を削減
- `DTextPicture.js` の修正：
  - 同サイズのビットマップをキャッシュ
  - DOM 要素の大量生成を削減
- `KMS_Minimap.js` の修正：
  - 二重バッファリングを追加し、既に描画されたミニマップを保持し、未変更領域をブリット
  - カスタムダーティフラグを使用し、変更されたピクセルのみを更新
- `PictureZIndex.js` の再構築：
  - ダーティフラグ付きの場合、描画前に画像をソート
  - フレーム毎に繰り返される重複ソート処理を削減
- 高リフレッシュレートモニターをサポートする独自の フェイクフレーム ™（画像補間）フレームワークを実装
  - フェイクフレーム ™ は商標ではありません。™ 記号は機能名の一部として、コメディ効果のために使用されています。

最適化手法の詳しい説明については、以下（英語のみ）をご参照ください：
[The Brutal Optimization of RPG Maker MV](https://tsdo.in/blog/optimizing-rmmv/)
